FROM nvidia/cuda:12.1.0-devel-ubuntu22.04

WORKDIR /app

# Install python, pip, and curl for healthcheck
RUN apt-get update && apt-get install -y python3 python3-pip git curl && \
    rm -rf /var/lib/apt/lists/*

# Install vLLM nightly as per HunyuanOCR requirements
# We use uv for faster and more reliable resolution
RUN pip3 install uv && \
    uv pip install --system -U vllm --pre --extra-index-url https://wheels.vllm.ai/nightly --extra-index-url https://download.pytorch.org/whl/cu129 --index-strategy unsafe-best-match

# Install latest transformers from source (HunyuanOCR requires newest version)
RUN pip3 install --upgrade git+https://github.com/huggingface/transformers.git

# Expose port
EXPOSE 8102

# Command to run vLLM for HunyuanOCR
# No custom logits processors needed (unlike DeepSeek)
CMD ["vllm", "serve", "tencent/HunyuanOCR", "--no-enable-prefix-caching", "--mm-processor-cache-gb", "0", "--port", "8102", "--trust-remote-code", "--gpu-memory-utilization", "0.2"]
